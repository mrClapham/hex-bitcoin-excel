<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset=utf-8>
    <title>Bitstamp live order book example</title>
</head>
<body>
<h1 align="center">Bitstamp order book</h1>

<div id="bids_placeholder" style="float:left;">
    <h2>Bids</h2>

    <div class="bid" price="0" amount="0" style="visibility:hidden;">laoding</div>

</div>

<div id="asks_placeholder" style="float:right; text-align:right;">
    <h2>Asks</h2>

    <div class="ask" price="100000" amount="0" style="visibility:hidden;">loading</div>

</div>

<script src="https://d3dy5gmtp8yhk7.cloudfront.net/2.1/pusher.min.js" type="text/javascript"></script>
<script type="text/javascript" charset="utf-8" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript">

    $(function() {
        var bids_placeholder = $("#bids_placeholder")
        var asks_placeholder = $("#asks_placeholder")
        var pusher = new Pusher('de504dc5763aeef9ff52');

        $.getJSON('https://www.bitstamp.net/api/order_book/', function(data) {
            var html = '<h2>Bids</h2>';
            for(i=0;i<500;i++) {
                html = html + '<div class="bid" amount="' + data['bids'][i][1] + '" price="' + data['bids'][i][0] + '">' + data['bids'][i][1] + ' BTC @ ' + data['bids'][i][0] + ' USD' + '</div>';
                bids_placeholder.html( html );
            }

            var html = '<h2>Asks</h2>';
            for(i=0;i<500;i++) {
                html = html + '<div class="ask" amount="' + data['asks'][i][1] + '" price="' + data['asks'][i][0] + '">' + data['asks'][i][1] + ' BTC @ ' + data['asks'][i][0] + ' USD' + '</div>';
                asks_placeholder.html( html );
            }

        });

        var order_book_channel = pusher.subscribe('diff_order_book');

        order_book_channel.bind('data', function(data) {
            bids_placeholder.innerHTML = '';
            asks_placeholder.innerHTML = '';

            //console.log(data);

            for(i=0;i<data['bids'].length;i++) {
                //bids_placeholder.innerHTML = bids_placeholder.innerHTML + data['bids'][i][1] + ' BTC @ ' + data['bids'][i][0] + ' USD' + '<br />';
                var found = false;

                $('#bids_placeholder div.bid').each(function(x, el) {
                    var price = parseFloat($(el).attr('price'));
                    var amount = parseFloat($(el).attr('amount'));

                    if (found == false) {
                        if (parseFloat(price) == parseFloat(data['bids'][i][0])) {
                            if (parseFloat(data['bids'][i][1]) == 0.0) {
                                $(el).remove();
                            } else {
                                $(el).attr('amount', data['bids'][i][1])
                                $(el).html(data['bids'][i][1] + ' BTC @ ' + data['bids'][i][0] + ' USD')
                            }
                            found = true;
                        } else if (parseFloat(price) < parseFloat(data['bids'][i][0])) {
                            if (parseFloat(data['bids'][i][1]) > 0.0) {
                                $(el).before( '<div class="bid" amount="' + data['bids'][i][1] + '" price="' + data['bids'][i][0] + '">' + data['bids'][i][1] + ' BTC @ ' + data['bids'][i][0] + ' USD' + '</div>' );
                            }
                            found = true;
                        }
                    }
                    //if ( $(el).attr('price') > data['bids'][i][0] ) {
                    //    $(el).
                    //}
                });
            }
            for(i=0;i<data['asks'].length;i++) {
                //asks_placeholder.innerHTML = asks_placeholder.innerHTML + data['asks'][i][1] + ' BTC @ ' + data['asks'][i][0] + ' USD' + '<br />';
                var found = false;
                $('#asks_placeholder div.ask').each(function(x, el) {
                    var price = parseFloat($(el).attr('price'));
                    var amount = parseFloat($(el).attr('amount'));

                    if (found == false) {
                        if (price == data['asks'][i][0]) {
                            if (parseFloat(data['asks'][i][1]) == 0) {
                                $(el).remove();
                            } else {
                                $(el).attr('amount', data['asks'][i][1])
                                $(el).html(data['asks'][i][1] + ' BTC @ ' + data['asks'][i][0] + ' USD')
                            }
                            found = true;
                        } else if (parseFloat(price) > parseFloat(data['asks'][i][0])) {
                            if (parseFloat(data['asks'][i][1]) > 0) {
                                $(el).before( '<div class="ask" amount="' + data['asks'][i][1] + '" price="' + data['asks'][i][0] + '">' + data['asks'][i][1] + ' BTC @ ' + data['asks'][i][0] + ' USD' + '</div>' );
                            }
                            found = true;
                        }
                    }
                });
            }
        });
    });
</script>
</body>
</html>